---
title: æ–­ç‚¹è°ƒè¯•
description: ç®€å•æœ‰æ•ˆçš„ Android è°ƒè¯•æ–¹æ³• ğŸ›
ogImage: '../../assets/book.jpg'
---

**æœ¬æ–‡æ‰€æœ‰æºç å‡åŸºäº WebRTC M85 (branch-heads/4183) ç‰ˆæœ¬è¿›è¡Œåˆ†æã€‚**

WebRTC åœ¨ Android ä¸Šçš„æ–­ç‚¹è°ƒè¯•è¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ï¼Œç›®å‰ä¸­æ–‡äº’è”ç½‘å¼•ç”¨å¾—æ¯”è¾ƒå¤šçš„è¿™ç¯‡ [*macOS ä¸‹å•æ­¥è°ƒè¯• WebRTC Android & iOS*](https://blog.piasy.com/2018/08/14/build-webrtc/index.html) åœ¨ç¬”è€…çœ‹æ¥æ˜¾å¾—å¤æ‚äº†ã€‚ç¬”è€…ç»“åˆå¦ä¸€ç¯‡æ–‡ç«  [*WebRTC Android çš„è°ƒè¯•*](http://blog.pprtc.com/2020/10/14/WebRTC-Android-debug/) ç»™å‡ºä¸€ä¸ªç®€å•æœ‰æ•ˆçš„ Android è°ƒè¯•æ–¹æ³•ï¼ˆåŸæ–‡ç•¥æ˜¾æ™¦æ¶©ï¼‰ã€‚

## ç¼–è¯‘ Debug åŒ…

æ‰“æ–­ç‚¹è‡ªç„¶éœ€è¦ä½¿ç”¨åˆ°åŒ…å«è°ƒè¯•ä¿¡æ¯çš„ .so æ–‡ä»¶ã€‚é¦–å…ˆè¦é¿å…ç¼–è¯‘æ—¶è¿™äº›ä¿¡æ¯è¢« strip æ‰ï¼Œå› æ­¤éœ€è¦ä¿®æ”¹ Android å¹³å°çš„ç¼–è¯‘é…ç½®ï¼Œæ–‡ä»¶è·¯å¾„å‚è§ä»£ç æ ‡é¢˜ï¼š

```bash:title=./build/toolchain/android/BUILD.gn
...
template("android_clang_toolchain") {
  ...
  _prefix = rebase_path("$clang_base_path/bin", root_build_dir)
  cc = "$_prefix/clang"
  cxx = "$_prefix/clang++"
  ar = "$_prefix/llvm-ar"
  ld = cxx
  readelf = _tool_prefix + "readelf"
  nm = _tool_prefix + "nm"
  # æ³¨é‡Šæ‰ä¸‹é¢ä¸¤è¡Œé…ç½®ï¼Œå³å¯å®ç° unstrip
  # strip = rebase_path("//buildtools/third_party/eu-strip/bin/eu-strip",
  #                     root_build_dir)
  # use_unstripped_as_runtime_outputs = android_unstripped_runtime_outputs
  ...
}
...
```

æ¥ç€æˆ‘ä»¬å¯ä»¥æ ¹æ® [ç¼–è¯‘æºç ](../webrtc-compilation/) è¿›è¡Œç¼–è¯‘ï¼Œä¸è¿‡æˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€äº› build_aar.py çš„ç¼–è¯‘å‚æ•°ï¼š

```bash
$ ./tools_webrtc/android/build_aar.py \
  --extra-gn-args "is_debug=true symbol_level=2 android_full_debug=true" \
  --arch arm64-v8a
```

è¿™é‡Œæˆ‘ä»¬åªéœ€è¦ç¼–è¯‘ arm64-v8a æ¶æ„çš„åŒ…ç”¨æ¥åšçœŸæœºè°ƒè¯•ï¼ˆç¼–è¯‘å…¨æ¶æ„éœ€è¦å¤§çº¦ 60 åˆ†é’Ÿï¼‰ã€‚ç¼–è¯‘å®Œæˆåè®°ä½å°†ç”Ÿæˆçš„ libwebrtc.aar æ‹·è´åˆ°æœ¬æœºï¼ˆå®¿ä¸»æœºï¼‰ä¸Šã€‚

PSï¼Œunstrip ç¼–è¯‘ armeabi-v7a æ—¶ä¼šæŠ›å‡º `ERROR Input to target not generated by a dependency.` ï¼Œè€ƒè™‘åˆ°è¿™ä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œç¬”è€…è®¤ä¸ºæ²¡æœ‰å¿…è¦ä¸“é—¨èŠ±æ—¶é—´è§£å†³ã€‚ä¸è¿‡å¦‚æœæœ‰è¯»è€…çŸ¥é“è§£å†³æ–¹æ¡ˆå¯ä»¥ç•™è¨€è¯„è®º ğŸ™

## å‡†å¤‡ WebRTC æºç 

æœ‰äº†åŒ…å«è°ƒè¯•ä¿¡æ¯çš„ .so æ–‡ä»¶ä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¯¹åº”çš„æºç ã€‚å¦‚æœè¯»è€…æ²¡æœ‰ä¿®æ”¹ WebRTC æºç çš„æ‰“ç®—ï¼Œåˆ™åªéœ€è¦åœ¨ macOS ä¸Šé…ç½®å¥½ [depot_tools](https://commondatastorage.googleapis.com/chrome-infra-docs/flat/depot_tools/docs/html/depot_tools_tutorial.html#_setting_up) ç„¶åç›´æ¥ fetch æºç åˆ°æœ¬æœºå¹¶åˆ‡æ¢åˆ°å¯¹åº”åˆ†æ”¯å°±å¯ä»¥äº†ã€‚macOS åªæ˜¯ä¸èƒ½ç›´æ¥ç¼–è¯‘ WebRTC è€Œå·²ï¼Œdepot_tools è¿˜æ˜¯å¯ä»¥ä½¿ç”¨çš„ã€‚

å¦‚æœä½ éœ€è¦è°ƒè¯•çš„æ˜¯è‡ªå·±æ”¹åŠ¨è¿‡çš„ WebRTC ä»£ç ï¼Œåˆ™éœ€è¦æŠŠæ”¹åŠ¨è¿‡çš„ä»£ç åŒæ­¥åˆ°æœ¬æœºã€‚é¦–å…ˆæ‰§è¡Œ `vagrant halt` å…³é—­è™šæ‹Ÿæœºï¼Œç„¶ååœ¨ Vagrantfile ä¸­åšå¦‚ä¸‹é…ç½®ï¼Œå¦åˆ™ä»è™šæ‹Ÿæœº**æ‰¹é‡**æ‹·è´æºç åˆ°æœ¬æœºçš„å…±äº«ç›®å½•æ—¶ä¼šå› ä¸ºæƒé™é—®é¢˜è€Œå¤±è´¥ï¼š

```bash:title=Vagrantfile
Vagrant.configure("2") do |config|
  ...
  # å°† Vagrantfile æ‰€åœ¨çš„ç›®å½•æŒ‚è½½åˆ°è™šæ‹Ÿæœºçš„ /vagrant ç›®å½•ï¼Œ
  # ä¸”è¯¥ç›®å½•çš„è¯»å†™æƒé™ä¸º 775ï¼Œæ–‡ä»¶è¯»å†™æƒé™ä¸º 777
  config.vm.synced_folder ".", "/vagrant",
    mount_options: ["dmode=775,fmode=777"]
end
```

ç„¶åå†æ‰§è¡Œ `vagrant up` é‡å¯è™šæ‹Ÿæœºï¼Œå†æ‰§è¡Œ `vargant ssh` ç™»å½•è™šæ‹Ÿæœºã€‚æ­¤æ—¶å†æ‰§è¡Œæ‰¹é‡æ‹·è´æºç åˆ°æœ¬æœºå°±ä¸ä¼šå†é‡åˆ°æƒé™é—®é¢˜äº†ã€‚

PSï¼Œèªæ˜çš„è¯»è€…å¯èƒ½å·²ç»æƒ³åˆ°ï¼Œå¦‚æœä»æœ€å¼€å§‹ [ç¼–è¯‘æºç ](../webrtc-compilation/) æ—¶å°±ç›´æ¥æŠŠæºç  fetch åˆ°å…±äº«ç›®å½•ï¼Œæœ¬æœºå’Œè™šæ‹Ÿæœºä¸å°±å¯ä»¥å…±äº«åŒä¸€ä»½æºç äº†å˜›ï¼Ÿç¬”è€…æœ€åˆä¹Ÿæ˜¯è¿™æ ·æƒ³çš„ï¼Œå¯æ˜¯åœ¨å…±äº«ç›®å½•å¹¶ä¸èƒ½ç¼–è¯‘æˆåŠŸã€‚æ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è‡ªå·±è¯•ä¸€è¯•ï¼Œå¦‚æœæœ‰è§£å†³æ–¹æ¡ˆå¯ä»¥ç•™è¨€è¯„è®º ğŸ˜„

## æ–­ç‚¹è°ƒè¯•é…ç½®

æˆ‘ä»¬ç»§ç»­ä»¥ [mthli/YaaRTC](https://github.com/mthli/YaaRTC) è¿™ä¸ªé¡¹ç›®ä¸ºä¾‹ï¼Œé¦–å…ˆå°†é¡¹ç›®é‡Œçš„ libwebrtc.aar æ›¿æ¢ä¸ºæˆ‘ä»¬è‡ªå·±åˆšåˆšç¼–è¯‘å¥½çš„ libwebrtc.aarã€‚æ¥ç€éœ€è¦åœ¨ `app/build.gradle` ä¸­åšå¦‚ä¸‹é…ç½®ï¼š

```groovy:title=app/build.gradle
...
android {
  ...
  buildTypes {
    ...
    debug {
      ...
      debuggable true     // å¿…é¡»è®¾ç½®ä¸º true
      jniDebuggable true  // å¿…é¡»è®¾ç½®ä¸º true
      minifyEnabled false // å¿…é¡»è®¾ç½®ä¸º false
    }
  }

  ...
  packagingOptions {
    ...
    // å¦‚æœä¸è®¾ç½® doNotStripï¼Œç¼–è¯‘å‡ºæ¥çš„å®‰è£…åŒ…è¿˜æ˜¯ä¼šä¸¢å¤±è°ƒè¯•ä¿¡æ¯ï¼›
    // å› ä¸ºæˆ‘ä»¬åªç¼–è¯‘äº† arm64-v8a æ¶æ„çš„åŒ…ï¼Œæ‰€ä»¥åªéœ€è¦é…ç½®è¿™ä¸€è¡Œå³å¯
    doNotStrip "*/arm64-v8a/*.so"
  }
}
...
```

ç„¶åå°† Android Studio çš„ Run â” Edit Configuration&#8230; çš„ Debug type è®¾ç½®ä¸º `Dual (Java + Native)` ï¼Œå¦åˆ™ä½ å°†æ— æ³•è°ƒè¯•åˆ° Native å±‚é¢çš„ä»£ç ï¼š

![](./dual.png)

ç°åœ¨è®©æˆ‘ä»¬åœ¨ WebRTC Java å±‚æ‰“ä¸€ä¸ªæ–­ç‚¹ï¼Œæ¯”å¦‚ `PeerConnection.nativeCreateOffer()` è¿™ä¸ªæ–¹æ³•ã€‚æ˜¾è€Œæ˜“è§ï¼Œæ­¤æ—¶ä¸è®ºä½ æ€ä¹ˆæ“ä½œ Debuggerï¼Œéƒ½ä¸å¯èƒ½å•æ­¥åˆ° Native å±‚ã€‚ä¸è¿‡è¿™ä¸é‡è¦ï¼Œæˆ‘ä»¬å…ˆå¯åŠ¨ Debugger å¹¶è¿è¡Œåˆ°æ–­ç‚¹å¤„å†è¯´ã€‚

ç„¶åæˆ‘ä»¬åˆ‡æ¢åˆ° Debugger çš„ LLDB å‘½ä»¤è¡Œï¼Œæ­¤æ—¶è¿™ä¸ª Tab æ˜¯ä¸èƒ½è¾“å…¥ä»»ä½•å‘½ä»¤çš„ã€‚æˆ‘ä»¬éœ€è¦ç‚¹å‡»å·¦è¾¹çš„ï¼ˆçº¢è‰²ç®­å¤´æ‰€æŒ‡çš„ï¼‰æš‚åœæŒ‰é’®ï¼Œè®©å…¶å˜ä¸ºå¯è¾“å…¥å‘½ä»¤çš„æ¨¡å¼ï¼š

![](./pause.png)

å½“ App è¿è¡Œåˆ°æ–­ç‚¹å¤„å¹¶è‡ªåŠ¨æš‚åœæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è¾“å…¥å¦‚ä¸‹ LLDB å‘½ä»¤å¹¶å¾—åˆ°è¾“å‡ºï¼š

```bash
# https://stackoverflow.com/a/53065726/4696820
# æŸ¥çœ‹ Native å±‚ webrtc::PeerConnection::RestartIce è¿™ä¸ªæ–¹æ³•çš„è°ƒè¯•ä¿¡æ¯ï¼›
# è¿™é‡Œé€‰ç”¨ RestartIce è€Œä¸æ˜¯ CreateOffer ä½œä¸ºç¤ºä¾‹çš„åŸå› æ˜¯å…¶è¾“å‡ºå•ä¸€ï¼Œæ˜“äºé˜…è¯»
(lldb) image lookup -vrn webrtc::PeerConnection::RestartIce
```

![](./lldb.png)

çœ‹åˆ° CompileUnit è¿™ä¸€è¡Œï¼ˆçº¢æ¡†éƒ¨åˆ†ï¼‰ï¼Œæ˜ç¡®æŒ‡å‡ºäº† RestartIce è¿™ä¸ªæ–¹æ³•æ‰€å¤„çš„æºç è·¯å¾„ã€‚ä¸è¿‡æ˜¾ç„¶æˆ‘ä»¬æœ¬æœºçš„ Android Studio æ˜¯æ— æ³•ç´¢å¼•åˆ°è¿™ä¸ªè·¯å¾„çš„ï¼Œå› ä¸ºè¿™æ˜¯è™šæ‹Ÿæœºé‡Œçš„è·¯å¾„ã€‚

å¦‚æœè¯»è€…åªæ˜¯éœ€è¦ä½¿ç”¨ LLDB å‘½ä»¤è¡Œæ‰“æ–­ç‚¹çš„è¯ï¼Œé‚£ä¹ˆæ–‡ç« è¯»åˆ°è¿™é‡Œå°±å¯ä»¥ç»“æŸäº†ã€‚ä½†æˆ‘ä»¬çš„ç›®çš„è‚¯å®šä¸æ˜¯é€šè¿‡å‘½ä»¤è¡Œæ‰“æ–­ç‚¹ï¼Œè€Œæ˜¯å¸Œæœ›ä½¿ç”¨ Android Studio çš„å›¾å½¢ç•Œé¢ç›´æ¥æ‰“æ–­ç‚¹ã€‚å› æ­¤éœ€è¦å°† CompileUnit è®°å½•çš„è™šæ‹Ÿæœºè·¯å¾„ä¸æˆ‘ä»¬æœ¬æœºçš„ WebRTC æºç å…³è”èµ·æ¥ã€‚

å‡è®¾æœ¬æœºçš„ WebRTC æºç æ‰€åœ¨è·¯å¾„ä¸º `~/GitHub/webrtc/src` ï¼Œåˆ™æˆ‘ä»¬éœ€è¦å°† CompileUnit ä¸­çš„è·¯å¾„å‰ç¼€ `./../../../home/vagrant/webrtc/src` æ›¿æ¢ä¸ºè¿™ä¸ªè·¯å¾„ã€‚æ­¤æ—¶å¯ä»¥åœ¨ Android Studio Debugger çš„ LLDB Startup Commands ä¸­æ·»åŠ å¦‚ä¸‹å‘½ä»¤ï¼š

```bash
# NEW_PATH_PREFIX åŠ¡å¿…ä¸ºç»å¯¹è·¯å¾„ï¼Œå¦åˆ™ LLDB ä¼šæ›¿æ¢å¤±è´¥ï¼ˆæ— æ³•è¯†åˆ«ï¼‰
# settings set target.source-map OLD_PATH_PREFIX NEW_PATH_PREFIX
settings set target.source-map ./../../../home/vagrant/webrtc/src /Users/mingliang.li/GitHub/webrtc/src
```

![](./startup.png)

ç„¶åä½ å°±å¯ä»¥éšæ„åœ¨æœ¬æœºçš„ WebRTC æºç ä¸Šæ‰“æ–­ç‚¹äº†ã€‚æ¯”å¦‚ä½¿ç”¨ Android Studio æ‰“å¼€æœ¬æœºçš„ `~/GitHub/webrtc/src/pc/peer_connection.cc` å¹¶åœ¨ `PeerConnection::CreateOffer` è¿™ä¸ªæ–¹æ³•ä¸­éšæ„æ‰“ä¸€ä¸ªæ–­ç‚¹ï¼Œç„¶åä»¥ Debug æ¨¡å¼ç¼–è¯‘å¹¶è¿è¡Œä¹‹ï¼š

![](./breakpoint.png)

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸæ‰“ä¸Šæ–­ç‚¹äº†ã€‚æœ‰äº†æ–­ç‚¹è°ƒè¯•èƒ½åŠ›ä»¥åï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥æ·±å…¥æºç å­¦ä¹  WebRTC äº†ï¼›æœ¬ä¹¦åç»­äº¦å°†ç»“åˆæºç ï¼Œè§£æ„ WebRTC çš„å†…éƒ¨æµç¨‹ ğŸ»

åœ¨å®é™…çš„å›¢é˜Ÿå¼€å‘ WebRTC çš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½æ˜¯ç”±æŸä¸€æ–¹åŒæ—¶ç»´æŠ¤å’Œè¾“å‡ºåŒ…å«å…¨éƒ¨è°ƒè¯•ä¿¡æ¯çš„ Debug åŒ…ï¼Œå’Œå»é™¤æ‰€æœ‰è°ƒè¯•ä¿¡æ¯çš„ Release åŒ…ã€‚å¯¹äºå…¶ä»–å¼€å‘åŒå­¦è€Œè¨€ï¼Œå³å¯ä½¿ç”¨ä¸Šè¿° LLDB è·¯å¾„æ›¿æ¢çš„æ–¹å¼ï¼Œå°†è‡ªå·±æœ¬æœºçš„ WebRTC æºç ä¸ Debug åŒ…å…³è”èµ·æ¥ï¼Œä¸€åŠ³æ°¸é€¸ã€‚

---

**ç›®å‰ [https://appr.tc](https://appr.tc) å·²è¢« Google åœç”¨ï¼Œæœ‰èƒ½åŠ›çš„è¯»è€…å¯ä»¥è‡ªè¡Œæ­å»º [webrtc/apprtc](https://github.com/webrtc/apprtc) æœåŠ¡ã€‚**
